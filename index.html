<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NEON PONG: MULTIPLAYER EDITION</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    body {
        margin: 0;
        background-color: #050505;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
        font-family: 'Press Start 2P', cursive;
    }

    #game-container {
        position: relative;
        box-shadow: 0 0 50px rgba(0, 255, 255, 0.2);
        border: 4px solid #333;
        border-radius: 4px;
    }

    canvas {
        display: block;
        background: radial-gradient(circle at center, #1a1a1a, #000000);
    }

    .scanlines {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            to bottom,
            rgba(255,255,255,0),
            rgba(255,255,255,0) 50%,
            rgba(0,0,0,0.2) 50%,
            rgba(0,0,0,0.2)
        );
        background-size: 100% 4px;
        pointer-events: none;
        z-index: 10;
        box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
    }

    #ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 20;
        text-align: center;
        color: white;
        text-shadow: 4px 4px #ff00de;
    }

    .hidden { display: none !important; }
    
    h1 { 
        font-size: 40px; 
        margin-bottom: 30px; 
        color: #0ff; 
    }
    
    p { 
        font-size: 14px; 
        color: #aaa; 
        line-height: 1.5; 
    }
    
    .menu-section {
        margin: 15px 0;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    label {
        font-size: 12px;
        color: #0ff;
        margin-bottom: 8px;
        text-shadow: 2px 2px #ff00de;
    }
    
    input, select {
        font-family: 'Press Start 2P', cursive;
        font-size: 12px;
        padding: 10px 20px;
        background-color: #1a1a1a;
        color: #0ff;
        border: 2px solid #0ff;
        border-radius: 4px;
        text-shadow: 0 0 5px #0ff;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        text-align: center;
        width: 250px;
    }
    
    input {
        cursor: text;
    }
    
    select {
        cursor: pointer;
    }
    
    input:focus, select:hover {
        background-color: #2a2a2a;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        outline: none;
    }
    
    select option {
        background-color: #1a1a1a;
        color: #0ff;
    }
    
    button {
        font-family: 'Press Start 2P', cursive;
        font-size: 14px;
        padding: 15px 30px;
        margin: 10px;
        background-color: #1a1a1a;
        color: #ff0;
        border: 3px solid #ff0;
        border-radius: 4px;
        cursor: pointer;
        text-shadow: 0 0 10px #ff0;
        box-shadow: 0 0 20px rgba(255, 255, 0, 0.4);
        transition: all 0.3s;
    }
    
    button:hover:not(:disabled) {
        background-color: #ff0;
        color: #000;
        transform: scale(1.05);
        box-shadow: 0 0 30px rgba(255, 255, 0, 0.8);
    }
    
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .status {
        font-size: 10px;
        color: #ff0;
        margin-top: 15px;
        min-height: 20px;
    }
    
    .room-code {
        font-size: 24px;
        color: #0f0;
        margin: 20px 0;
        padding: 15px 30px;
        background-color: rgba(0, 255, 0, 0.1);
        border: 2px solid #0f0;
        border-radius: 8px;
        text-shadow: 0 0 10px #0f0;
        letter-spacing: 5px;
    }
    
    .blink { 
        animation: blinker 1s linear infinite; 
    }

    @keyframes blinker { 
        50% { opacity: 0; } 
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
</style>
</head>
<body>

<div id="game-container">
    <canvas id="game" width="900" height="500"></canvas>
    <div class="scanlines"></div>
    
    <div id="ui-layer">
        <h1>NEON PONG</h1>
        <div id="menu-screen">
            <p style="margin-bottom: 20px;">Multiplayer Edition â€¢ First to 10 Wins</p>
            
            <div class="menu-section">
                <label>YOUR PADDLE COLOR:</label>
                <select id="paddle-color">
                    <option value="#0ff" selected>CYAN</option>
                    <option value="#0f0">GREEN</option>
                    <option value="#ff0">YELLOW</option>
                    <option value="#f0f">MAGENTA</option>
                    <option value="#00f">BLUE</option>
                    <option value="#f80">ORANGE</option>
                    <option value="#fff">WHITE</option>
                </select>
            </div>
            
            <div class="menu-section">
                <label>BALL COLOR:</label>
                <select id="ball-color">
                    <option value="#fff" selected>WHITE</option>
                    <option value="#0ff">CYAN</option>
                    <option value="#0f0">GREEN</option>
                    <option value="#ff0">YELLOW</option>
                    <option value="#f0f">MAGENTA</option>
                    <option value="#f00">RED</option>
                    <option value="#f80">ORANGE</option>
                </select>
            </div>
            
            <div class="button-group">
                <button id="create-btn">CREATE ROOM</button>
                <button id="show-join-btn">JOIN ROOM</button>
            </div>
            
            <div id="join-section" class="hidden">
                <div class="menu-section">
                    <label>ENTER ROOM CODE:</label>
                    <input type="text" id="room-code-input" placeholder="Enter 6-digit code" maxlength="6">
                </div>
                <button id="join-btn">CONNECT</button>
            </div>
            
            <div id="waiting-section" class="hidden">
                <p>Your Room Code:</p>
                <div class="room-code" id="room-code-display"></div>
                <p class="blink">Waiting for opponent to join...</p>
            </div>
            
            <div class="status" id="status"></div>
        </div>
        
        <div id="gameover-screen" class="hidden"></div>
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
/**
 * IMPROVED MULTIPLAYER NEON PONG
 * Features: Latency Smoothing, Screen Shake, and Predictive Sync
 */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const uiLayer = document.getElementById("ui-layer");
const menuScreen = document.getElementById("menu-screen");
const gameoverScreen = document.getElementById("gameover-screen");
const createBtn = document.getElementById("create-btn");
const showJoinBtn = document.getElementById("show-join-btn");
const joinBtn = document.getElementById("join-btn");
const joinSection = document.getElementById("join-section");
const waitingSection = document.getElementById("waiting-section");
const roomCodeDisplay = document.getElementById("room-code-display");
const roomCodeInput = document.getElementById("room-code-input");
const statusEl = document.getElementById("status");

// Game Constants
const PADDLE_H = 80;
const PADDLE_W = 15;
const WIN_SCORE = 10;

// Dynamic Colors
let COLOR_PLAYER = "#0ff";
let COLOR_OPPONENT = "#ff00de";
let COLOR_BALL = "#fff";

// State
let peer = null;
let connection = null;
let roomCode = "";
let playerSide = null;
let gameState = "MENU";
let shakeIntensity = 0;
let isHost = false;
let particles = [];
let trail = [];

// Paddle smoothing targets
let targetOpponentY = 200;

// Objects
let leftPaddle = { x: 20, y: 200, score: 0, color: COLOR_PLAYER };
let rightPaddle = { x: canvas.width - 35, y: 200, score: 0, color: COLOR_OPPONENT };
let ball = { x: 450, y: 250, dx: 5, dy: 3, r: 8, speed: 7 };

const keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

/** AUDIO ENGINE **/
let audioCtx;
function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playSound(type) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    const now = audioCtx.currentTime;

    if (type === "hit") {
        osc.type = "square";
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(); osc.stop(now + 0.1);
    } else if (type === "score") {
        osc.type = "triangle";
        osc.frequency.setValueAtTime(200, now);
        osc.frequency.linearRampToValueAtTime(600, now + 0.3);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
        osc.start(); osc.stop(now + 0.3);
    }
}

/** PARTICLES **/
class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y;
        this.size = Math.random() * 5 + 2;
        this.speedX = (Math.random() - 0.5) * 8;
        this.speedY = (Math.random() - 0.5) * 8;
        this.color = color;
        this.life = 1.0;
    }
    update() {
        this.x += this.speedX; this.y += this.speedY;
        this.life -= 0.02;
    }
    draw() {
        ctx.fillStyle = this.color;
        ctx.globalAlpha = this.life;
        ctx.fillRect(this.x, this.y, this.size, this.size);
        ctx.globalAlpha = 1.0;
    }
}

function spawnParticles(x, y, color) {
    for (let i = 0; i < 15; i++) particles.push(new Particle(x, y, color));
}

/** MULTIPLAYER LOGIC **/
function createRoom() {
    initAudio();
    COLOR_PLAYER = document.getElementById("paddle-color").value;
    COLOR_BALL = document.getElementById("ball-color").value;
    roomCode = Math.floor(100000 + Math.random() * 900000).toString();
    playerSide = "left"; isHost = true;
    
    peer = new Peer(roomCode);
    peer.on('open', () => {
        roomCodeDisplay.textContent = roomCode;
        waitingSection.classList.remove("hidden");
        statusEl.textContent = "Room Live!";
    });
    
    peer.on('connection', (conn) => {
        connection = conn;
        setupConnection();
    });
}

function joinRoom() {
    const code = roomCodeInput.value.trim();
    if (code.length !== 6) return;
    initAudio();
    COLOR_PLAYER = document.getElementById("paddle-color").value;
    playerSide = "right"; isHost = false;
    
    peer = new Peer();
    peer.on('open', () => {
        connection = peer.connect(code);
        setupConnection();
    });
}

function setupConnection() {
    connection.on('open', () => {
        if (isHost) {
            connection.send({ type: 'setup', ballColor: COLOR_BALL, hostColor: COLOR_PLAYER });
        }
        statusEl.textContent = "Syncing...";
        setTimeout(startGame, 1000);
    });

    connection.on('data', (data) => {
        if (data.type === 'setup') {
            COLOR_BALL = data.ballColor;
            COLOR_OPPONENT = data.hostColor;
        } else if (data.type === 'paddle') {
            targetOpponentY = data.y;
        } else if (data.type === 'ball') {
            // Apply data and keep predicting
            ball.x = data.x; ball.y = data.y;
            ball.dx = data.dx; ball.dy = data.dy;
        } else if (data.type === 'score') {
            leftPaddle.score = data.l; rightPaddle.score = data.r;
            playSound("score");
        }
    });
}

function startGame() {
    gameState = "PLAYING";
    menuScreen.classList.add("hidden");
    if (isHost) resetBall();
    
    // Low-latency sync loop
    setInterval(() => {
        if (connection?.open && gameState === "PLAYING") {
            const myPaddle = playerSide === "left" ? leftPaddle : rightPaddle;
            connection.send({ type: 'paddle', y: myPaddle.y });
        }
    }, 16);
}

/** GAME ENGINE **/
function resetBall() {
    ball.x = canvas.width / 2; ball.y = canvas.height / 2;
    ball.speed = 7;
    ball.dx = (Math.random() > 0.5 ? 1 : -1) * ball.speed;
    ball.dy = (Math.random() * 6) - 3;
}

function update() {
    if (gameState !== "PLAYING") return;

    // 1. Move Local Paddle
    const myPaddle = playerSide === "left" ? leftPaddle : rightPaddle;
    if (keys["w"] && myPaddle.y > 0) myPaddle.y -= 8;
    if (keys["s"] && myPaddle.y < canvas.height - PADDLE_H) myPaddle.y += 8;

    // 2. Smooth Opponent Paddle (Lerp)
    const oppPaddle = playerSide === "left" ? rightPaddle : leftPaddle;
    oppPaddle.y += (targetOpponentY - oppPaddle.y) * 0.3;

    // 3. Ball Physics (Host controls truth, Client predicts)
    ball.x += ball.dx;
    ball.y += ball.dy;

    if (isHost) {
        // Wall Bounce
        if (ball.y <= 0 || ball.y >= canvas.height) {
            ball.dy *= -1;
            connection.send({ type: 'ball', x: ball.x, y: ball.y, dx: ball.dx, dy: ball.dy });
        }

        // Paddle Collision Logic
        const checkHit = (p) => ball.x - ball.r < p.x + PADDLE_W && ball.x + ball.r > p.x && ball.y > p.y && ball.y < p.y + PADDLE_H;

        if (checkHit(leftPaddle) || checkHit(rightPaddle)) {
            ball.dx *= -1.05; // Speed up
            ball.dy += (Math.random() - 0.5) * 4;
            shakeIntensity = 10;
            playSound("hit");
            spawnParticles(ball.x, ball.y, COLOR_BALL);
            connection.send({ type: 'ball', x: ball.x, y: ball.y, dx: ball.dx, dy: ball.dy });
        }

        // Scoring
        if (ball.x < 0 || ball.x > canvas.width) {
            if (ball.x < 0) rightPaddle.score++; else leftPaddle.score++;
            playSound("score");
            resetBall();
            connection.send({ type: 'score', l: leftPaddle.score, r: rightPaddle.score });
            connection.send({ type: 'ball', x: ball.x, y: ball.y, dx: ball.dx, dy: ball.dy });
            if (leftPaddle.score >= WIN_SCORE || rightPaddle.score >= WIN_SCORE) gameState = "GAMEOVER";
        }
    }

    // Visuals
    trail.push({x: ball.x, y: ball.y});
    if (trail.length > 15) trail.shift();
    particles.forEach((p, i) => { p.update(); if (p.life <= 0) particles.splice(i, 1); });
    if (shakeIntensity > 0) shakeIntensity *= 0.9;
}

function draw() {
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    if (shakeIntensity > 1) ctx.translate((Math.random()-0.5)*shakeIntensity, (Math.random()-0.5)*shakeIntensity);

    // Net
    ctx.strokeStyle = "#222";
    ctx.setLineDash([10, 10]);
    ctx.strokeRect(canvas.width/2, 0, 0, canvas.height);

    // Trail
    trail.forEach((t, i) => {
        ctx.fillStyle = COLOR_BALL + Math.floor((i/trail.length)*50).toString(16).padStart(2, '0');
        ctx.beginPath(); ctx.arc(t.x, t.y, ball.r * (i/trail.length), 0, Math.PI*2); ctx.fill();
    });

    // Paddles
    ctx.shadowBlur = 15;
    ctx.fillStyle = playerSide === "left" ? COLOR_PLAYER : COLOR_OPPONENT;
    ctx.shadowColor = ctx.fillStyle;
    ctx.fillRect(leftPaddle.x, leftPaddle.y, PADDLE_W, PADDLE_H);

    ctx.fillStyle = playerSide === "right" ? COLOR_PLAYER : COLOR_OPPONENT;
    ctx.shadowColor = ctx.fillStyle;
    ctx.fillRect(rightPaddle.x, rightPaddle.y, PADDLE_W, PADDLE_H);

    // Ball
    ctx.fillStyle = COLOR_BALL; ctx.shadowColor = COLOR_BALL;
    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();

    particles.forEach(p => p.draw());
    ctx.restore();

    // Score
    ctx.shadowBlur = 0;
    ctx.font = "40px 'Press Start 2P'";
    ctx.fillStyle = "rgba(255,255,255,0.2)";
    ctx.fillText(leftPaddle.score, canvas.width*0.25, 80);
    ctx.fillText(rightPaddle.score, canvas.width*0.75, 80);

    if (gameState === "GAMEOVER") {
        ctx.fillStyle = "white";
        ctx.fillText("GAME OVER", canvas.width/2 - 150, canvas.height/2);
    }
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
createBtn.addEventListener("click", createRoom);
showJoinBtn.addEventListener("click", () => joinSection.classList.remove("hidden"));
joinBtn.addEventListener("click", joinRoom);
loop();

</script>

</body>
</html>
